const COINS=["bitcoin","ethereum","solana","dogecoin","ripple","binancecoin","cardano"],API_BASE="https://api.coingecko.com/api/v3/coins/markets",CORS_PROXY="https://corsproxy.io/?",DEMO_API_KEY="",REFRESH_INTERVAL=1e4,tableBody=document.getElementById("table-body"),skeleton=document.getElementById("skeleton"),statusText=document.getElementById("status-text"),errorBanner=document.getElementById("error-banner"),refreshBtn=document.getElementById("refresh-btn"),currencyFormatter=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}),numberFormatter=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),compactCurrency=new Intl.NumberFormat("en-US",{notation:"compact",style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});let intervalId,hasLoadedOnce=!1,usingProxy=!1;function buildApiUrl(e=!1){const t=new URLSearchParams({vs_currency:"usd",ids:COINS.join(","),sparkline:"false",price_change_percentage:"24h"});const n=`${API_BASE}?${t.toString()}`;return e?`${CORS_PROXY}${encodeURIComponent(n)}`:n}function setStatus(e,t="info"){statusText.textContent=e,statusText.style.color="error"===t?"#ff5a7a":"#8da0c2"}function showSkeleton(){skeleton.classList.add("active")}function hideSkeleton(){skeleton.classList.remove("active")}function formatChange(e){const t=e>=0;return`<span class="pill ${t?"positive":"negative"}">${t?"+":""}${numberFormatter.format(e??0)}%</span>`}function formatRow(e){return`\n    <tr class="flash">\n      <td>\n        <div class="coin-cell">\n          <img src="${e.image}" alt="${e.name} logo" loading="lazy">\n          <div>${e.name}</div>\n        </div>\n      </td>\n      <td class="muted">${e.symbol.toUpperCase()}</td>\n      <td>${currencyFormatter.format(e.current_price)}</td>\n      <td>${formatChange(e.price_change_percentage_24h)}</td>\n      <td>${compactCurrency.format(e.market_cap)}</td>\n    </tr>\n  `}async function fetchPrices(){hasLoadedOnce||showSkeleton(),setStatus(usingProxy?"Fetching via backup route...":"Fetching latest data..."),errorBanner.hidden=!0;try{renderTable(await fetchWithFallback()),setStatus(`Updated ${(new Date).toLocaleTimeString()}`),hasLoadedOnce=!0}catch(e){console.error(e),errorBanner.textContent="Unable to load data right now. Please try again shortly.",errorBanner.hidden=!1,setStatus("Connection issue. Retrying...","error")}finally{hideSkeleton()}}async function fetchWithFallback(){try{return usingProxy=!1,await fetchJson(buildApiUrl(!1))}catch(e){return console.warn("Primary fetch failed, retrying with proxy",e),usingProxy=!0,await fetchJson(buildApiUrl(!0))}}async function fetchJson(e){const t=await fetch(e,{cache:"no-store"});if(!t.ok)throw new Error(`API error: ${t.status}`);return t.json()}function renderTable(e){const t=e.sort((e,t)=>t.market_cap-e.market_cap).map(formatRow).join("");tableBody.innerHTML=t}function startAutoRefresh(){intervalId&&clearInterval(intervalId),intervalId=setInterval(fetchPrices,1e4)}refreshBtn.addEventListener("click",()=>{fetchPrices()}),document.addEventListener("visibilitychange",()=>{document.hidden?clearInterval(intervalId):(startAutoRefresh(),fetchPrices())}),fetchPrices(),startAutoRefresh();